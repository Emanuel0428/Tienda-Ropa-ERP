<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auditor√≠a</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d1edff;
            color: #0c5460;
            padding: 10px;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Auditor√≠a 2.0</h1>
    
    <div id="auth-section">
        <h2>1. Autenticaci√≥n</h2>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" placeholder="usuario@ejemplo.com">
        </div>
        <div class="form-group">
            <label>Contrase√±a:</label>
            <input type="password" id="password" placeholder="contrase√±a">
        </div>
        <button onclick="login()">Iniciar Sesi√≥n</button>
    </div>

    <div id="test-section" style="display: none;">
        <h2>2. Prueba de Creaci√≥n de Auditor√≠a</h2>
        
        <div class="form-group">
            <label>ID Tienda:</label>
            <input type="number" id="id_tienda" value="1">
        </div>
        <div class="form-group">
            <label>Fecha:</label>
            <input type="date" id="fecha">
        </div>
        <div class="form-group">
            <label>Quienes Reciben:</label>
            <input type="text" id="quienes_reciben" value="Personal de tienda">
        </div>
        <div class="form-group">
            <label>Observaciones:</label>
            <textarea id="observaciones" rows="3" placeholder="Observaciones..."></textarea>
        </div>
        
        <button onclick="testCrearAuditoria()">üß™ Probar Crear Auditor√≠a</button>
        <button onclick="verificarEstructuraBD()">üîç Verificar Estructura BD</button>
        <button onclick="cargarCategorias()">üìã Cargar Categor√≠as</button>
    </div>

    <div id="results"></div>

    <script>
        // Configuraci√≥n de Supabase (usar las mismas credenciales de tu proyecto)
        const SUPABASE_URL = 'TU_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY';
        
        // Nota: Necesitar√°s reemplazar estas credenciales con las reales
        let supabase;
        
        // Intentar inicializar Supabase con credenciales de ejemplo
        try {
            // Estas son credenciales de ejemplo - necesitas las reales
            supabase = window.supabase.createClient(
                'https://tu-proyecto.supabase.co',
                'tu-anon-key-aqui'
            );
        } catch (error) {
            showError('Error inicializando Supabase. Necesitas configurar las credenciales reales.');
        }

        // Configurar fecha por defecto
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Por favor ingresa email y contrase√±a');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                showSuccess('Autenticaci√≥n exitosa');
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('test-section').style.display = 'block';
                
            } catch (error) {
                showError('Error de autenticaci√≥n: ' + error.message);
            }
        }

        async function verificarEstructuraBD() {
            try {
                showResult('üîç Verificando estructura de base de datos...');
                
                // Verificar tabla auditorias
                const { data: auditorias, error: errorAuditorias } = await supabase
                    .from('auditorias')
                    .select('*')
                    .limit(1);
                
                if (errorAuditorias) {
                    showError('Error en tabla auditorias: ' + errorAuditorias.message);
                } else {
                    showSuccess('‚úÖ Tabla auditorias accesible');
                }

                // Verificar tabla categorias
                const { data: categorias, error: errorCategorias } = await supabase
                    .from('categorias')
                    .select('*')
                    .limit(5);
                
                if (errorCategorias) {
                    showError('Error en tabla categorias: ' + errorCategorias.message);
                } else {
                    showSuccess(`‚úÖ Tabla categorias accesible (${categorias?.length || 0} categor√≠as encontradas)`);
                    showResult('Categor√≠as encontradas:', categorias);
                }

                // Verificar tabla auditoria_preguntas
                const { data: auditPreguntas, error: errorAuditPreguntas } = await supabase
                    .from('auditoria_preguntas')
                    .select('*')
                    .limit(1);
                
                if (errorAuditPreguntas) {
                    showError('Error en tabla auditoria_preguntas: ' + errorAuditPreguntas.message);
                } else {
                    showSuccess('‚úÖ Tabla auditoria_preguntas accesible');
                }

            } catch (error) {
                showError('Error verificando estructura: ' + error.message);
            }
        }

        async function cargarCategorias() {
            try {
                showResult('üìã Cargando estructura completa de categor√≠as...');
                
                // Cargar categor√≠as con subcategor√≠as y preguntas
                const { data: categorias, error: errorCategorias } = await supabase
                    .from('categorias')
                    .select(`
                        *,
                        subcategorias!categorias_subcategorias_categoria_id_fkey (
                            *,
                            preguntas!subcategorias_preguntas_subcategoria_id_fkey (*)
                        )
                    `)
                    .eq('activo', true)
                    .order('orden');

                if (errorCategorias) {
                    showError('Error cargando categor√≠as: ' + errorCategorias.message);
                    return;
                }

                if (!categorias || categorias.length === 0) {
                    showError('No se encontraron categor√≠as en la base de datos');
                    return;
                }

                showSuccess(`‚úÖ ${categorias.length} categor√≠as cargadas correctamente`);
                
                let totalPreguntas = 0;
                categorias.forEach(cat => {
                    if (cat.subcategorias) {
                        cat.subcategorias.forEach(sub => {
                            if (sub.preguntas) {
                                totalPreguntas += sub.preguntas.length;
                            }
                        });
                    }
                });

                showResult(`Total de preguntas en el sistema: ${totalPreguntas}`);
                showResult('Estructura cargada:', categorias);

            } catch (error) {
                showError('Error cargando categor√≠as: ' + error.message);
            }
        }

        async function testCrearAuditoria() {
            try {
                showResult('üß™ Iniciando prueba de creaci√≥n de auditor√≠a...');
                
                // Obtener usuario actual
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    showError('Usuario no autenticado: ' + (userError?.message || 'Sin usuario'));
                    return;
                }

                showSuccess(`Usuario autenticado: ${user.email}`);

                // Recoger datos del formulario
                const formulario = {
                    id_tienda: parseInt(document.getElementById('id_tienda').value),
                    fecha: document.getElementById('fecha').value,
                    quienes_reciben: document.getElementById('quienes_reciben').value,
                    observaciones: document.getElementById('observaciones').value
                };

                showResult('Datos del formulario:', formulario);

                // Intentar crear auditor√≠a
                const { data: auditoriaData, error: auditoriaError } = await supabase
                    .from('auditorias')
                    .insert({
                        id_tienda: formulario.id_tienda,
                        id_auditor: user.id,
                        fecha: formulario.fecha,
                        quienes_reciben: formulario.quienes_reciben,
                        observaciones: formulario.observaciones,
                        estado: 'en_progreso',
                        calificacion_total: 0
                    })
                    .select()
                    .single();

                if (auditoriaError) {
                    showError('Error creando auditor√≠a: ' + auditoriaError.message);
                    showResult('Detalles del error:', auditoriaError);
                    return;
                }

                showSuccess('‚úÖ Auditor√≠a creada exitosamente');
                showResult('Auditor√≠a creada:', auditoriaData);

            } catch (error) {
                showError('Error en prueba: ' + error.message);
                console.error('Error completo:', error);
            }
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.getElementById('results').appendChild(div);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.getElementById('results').appendChild(div);
        }

        function showResult(message, data = null) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${message}</strong>`;
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                div.appendChild(pre);
            }
            document.getElementById('results').appendChild(div);
        }
    </script>
</body>
</html>